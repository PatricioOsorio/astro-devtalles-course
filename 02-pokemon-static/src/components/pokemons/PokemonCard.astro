---
import type { IPokemonResponse } from '../../interfaces/pokemon.response';
import { queryClient } from '../../lib/queryClient';
import { queryKeys } from '../../lib/queryKeys';
import { getPokemonByUrl } from '../../lib/services/pokemon.service';

interface Props {
  name: string;
  url: string;
}

const { name, url } = Astro.props;

const pokemon = await queryClient.fetchQuery<IPokemonResponse>({
  queryKey: queryKeys.pokemonDetail(name),
  queryFn: () => getPokemonByUrl(url),
});

const imageSrc = 'https://picsum.photos/100/100';

const formattedId = `#${pokemon.id.toString().padStart(4, '0')}`;

const displayName = pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1);

const formattedTypes = pokemon.types.map(({ type }) => type.name.replace('-', ' '));

const mainAbilities = pokemon.abilities
  .slice(0, 2)
  .map(({ ability }) => ability?.name ?? '')
  .filter(Boolean)
  .map((abilityName) => abilityName.replace('-', ' '));
---

<a
  class="flex h-full flex-col rounded-2xl border border-border bg-card p-4 text-card-foreground shadow-sm transition hover:border-primary/40 hover:shadow-md no-underline"
  href={`/pokemons/${name}`}
>
  <header class="flex items-start justify-between gap-3">
    <h3 class="text-xl font-semibold capitalize leading-tight">{displayName}</h3>
    <span
      class="rounded-md border border-border bg-background px-2 py-0.5 text-xs font-semibold text-muted"
    >
      {formattedId}
    </span>
  </header>

  <div class="my-4 grid place-items-center">
    <img
      src={imageSrc}
      alt={pokemon.name}
      class="size-25 rounded-full border border-border bg-background/70 p-1 object-contain"
      loading="lazy"
    />
  </div>

  <div class="mb-4 flex flex-wrap gap-2">
    {
      formattedTypes.map((typeName) => (
        <span class="rounded-full border border-primary/25 bg-primary/10 px-2.5 py-1 text-xs font-medium capitalize text-primary">
          {typeName}
        </span>
      ))
    }
  </div>

  <dl class="mt-auto grid grid-cols-3 gap-2 text-center">
    <div class="rounded-lg border border-border bg-background px-2 py-2">
      <dt class="text-[11px] uppercase tracking-wide text-muted">Exp</dt>
      <dd class="text-sm font-semibold text-foreground">{pokemon.base_experience}</dd>
    </div>
    <div class="rounded-lg border border-border bg-background px-2 py-2">
      <dt class="text-[11px] uppercase tracking-wide text-muted">Height</dt>
      <dd class="text-sm font-semibold text-foreground">{pokemon.height}</dd>
    </div>
    <div class="rounded-lg border border-border bg-background px-2 py-2">
      <dt class="text-[11px] uppercase tracking-wide text-muted">Weight</dt>
      <dd class="text-sm font-semibold text-foreground">{pokemon.weight}</dd>
    </div>
  </dl>

  {
    mainAbilities.length > 0 && (
      <p class="mt-3 text-xs text-muted capitalize">Abilities: {mainAbilities.join(', ')}</p>
    )
  }
</a>
